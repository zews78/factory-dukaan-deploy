<%- include("../partials/start") %>
<link type="text/css" rel="stylesheet" href="/css/products.css" />
<%- include("../partials/headBody") %>
<%- include("../partials/header") %>
<div class="wrapper">
    <%- include("../partials/sidenav") %>
    <div class="main_content">
        <div class="header">
            <h2>My Products</h2>
        </div>
        <% if(products.length > 0) { %>
            <div class="add-product">
                <h4>Number Of Products: <%= products.length %></h4>
            </div>
            <% } else { %>
            <p></p>
            <% } %>

        <% if(products.length < user.productLimit || user.productLimit==="unlimited") { %>
            <div class="add-product">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ModalAddProduct">Add Product</button>
            </div>
            <% } else { %>
                <div class="add-product">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ModalAddProduct" disabled style="background-color: #70aff3; color:rgb(54, 54, 54)">Add Product</button>
                </div>
                <div class="add-product">
                    <pre style="color:red">Product Selling Limit Exceeded </pre>
                </div>
                
            <% } %>

        <% for (var i = 0; i < products.length; i++) { %>
            <div class="products-wrapper">
                <div class="card mb-3 w-75">
                    <div class="row no-gutters">
                        <div class="col-md-4">
                            <img class="card-img-top" src="/images/product1.jpg" alt="Card image cap">
                        </div>
                        <div class="col-md-6">
                            <div class="card-body">
                                <h5 class="card-title"><%= products[i].title %></h5>
                                <h6><b>Price:</b> â‚¹<%= products[i].price %></h6>
                                <p class="card-text"><%= products[i].desc %></p>
                                <p class="card-text"><small class="text-muted">Added on <%= new Date( products[i].createdOn._seconds*1000).toDateString() %></small></p>
                            </div>
                        </div>
                        <input type="hidden" name="product-id" value='<%= productsId[i] %>' id='<%= productsId[i] %> productId'/>
                        <input type="hidden" name="product-id" value='<%= products[i].title %>' id='<%= productsId[i] %> title'/>
                        <input type="hidden" name="product-id" value='<%= products[i].price %>' id='<%= productsId[i] %> price'/>
                        <input type="hidden" name="product-id" value='<%= products[i].desc %>' id='<%= productsId[i] %> desc'/>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary editButton" data-toggle="modal" data-target="#ModalEditForm1" id='<%= productsId[i] %>'>Edit</button>
                            <button type="button" class="btn btn-danger deleteButton" id='<%= productsId[i] %>' >Delete</button>
                            <a href="/product/<%= productsId[i] %>"><button type="button" class="btn btn-info">View Details</button></a>
                        </div>
                    </div>
                </div>
            <% } %>

<%- include("../partials/footer") %>            
        
<div id="ModalEditForm1" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Product</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    
            </div>
            <p id="productID" style="color:gray"></p>
            <div class="modal-body">
                <form role="form" method="POST" action="">
                    <input type="hidden" name="_token" value="">
                    <div class="form-group">
                        <label class="control-label">Product Name</label>
                        <div>
                            <input type="text" class="form-control input-lg" name="user-name" value="" id="titleInput">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Price</label>
                        <div>
                            <input type="text" class="form-control input-lg" name="company-name" id="priceInput">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="control-label">Product Description</label>
                        <div>
                            <textarea class="form-control"  rows="4" id="descInput"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label">Product Images</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="customFile" accept=".jpg,.png" multiple data-show-upload="true" data-show-caption="true">
                            <label class="custom-file-label" for="customFile">Choose file</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div>
                            <button type="button" class="btn btn-success" onclick="editHandler()">Save</button>
                            <button type="submit" class="btn btn-secondary" data-dismiss="modal">Cancel</button>

                        </div>
                    </div>
                    <div class="form-group">
                        <div>

                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Delete Product</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
        </div>
        <div class="modal-body"> Are you sure you want to delete this product? This cannot be undone! </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <a href="" id="delete" class="btn btn-primary">Yes</a> </div>
      </div>
    </div>
  </div>

<!-- Modal - Add Product -->
<div id="ModalAddProduct" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add Product</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form >
                    <input type="hidden" name="_token" value="">
                    <div class="form-group">
                        <label class="control-label" id="product-name">Product Name</label>
                        <div>
                            <input type="text" required class="form-control input-lg" name="user-name" value="" id="addTitleInput">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Price</label>
                        <div>
                            <input type="text" required class="form-control input-lg" name="company-name" id="addPriceInput">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="control-label">Product Description</label>
                        <div>
                            <textarea class="form-control"  required rows="4" id="addDescInput"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label">Keywords <small>(seperated by comma)</small> </label>
                        <div>
                            <input type="text" required class="form-control input-lg" name="company-name" id="addKeywordsInput">
                        </div>
                    </div>

                    <div class="form-group" id="specs-form">
                        <div class="input-group">
                            <div class="input-group-prepend">
                            <span class="input-group-text">Specifications</span>
                            </div>
                            <input type="text" aria-label="First name" class="form-control border border-primary" placeholder="Title" id="specsTitle0" required>
                            <input type="text" aria-label="Last name" class="form-control border border-primary" placeholder="Description" style="border-radius: 0;" id="specsDesc0" required>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="specsHandler()">Add more specs</button>

                    <div class="form-group">
                        <label class="control-label">Product Images</label>
                        <div class="custom-file">
                            <input type="file" class="addcustom-file-input" id="addCustomFile" accept=".jpg,.png" multiple data-show-upload="true" data-show-caption="true">
                            <label class="custom-file-label" for="customFile">Choose file</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div>
                            <button type="button" class="btn btn-success" onclick="addProductHandler()">Save</button>
                            <button type="submit" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.querySelector('.custom-file-input').addEventListener('change',function(e) {
        var fileName = document.getElementById("customFile").files[0].name;
        var nextSibling = e.target.nextElementSibling
        nextSibling.innerText = fileName
    })
    
    var c=1;
    const specsHandler=()=>{
        
        $('#specs-form').append(`<div class="input-group ${c}"><div class="input-group-prepend"><span class="input-group-text">Specifications</span></div> <input type="text" aria-label="First name" class="form-control border border-primary" placeholder="Title" id="specsTitle${c}"><input type="text" aria-label="Last name" class="form-control border border-primary" placeholder="Description" id="specsDesc${c}" style="border-radius: 0;"></div>`)
        
        c=c+1;
    }
    const addProductHandler=async()=>{

        var specFields=document.getElementsByClassName("form-control border border-primary");
        var specs={};
        for(var i=0;i<specFields.length/2;i+=1){
            if(document.getElementById(`specsTitle${i}`).value===null || document.getElementById(`specsTitle${i}`).value==="" || document.getElementById(`specsDesc${i}`).value===null || document.getElementById(`specsDesc${i}`).value===""){
                continue;
            }else{specs[`${document.getElementById(`specsTitle${i}`).value}`]=`${document.getElementById(`specsDesc${i}`).value}`}
            
        }
        if(document.getElementById('addTitleInput').value===null || document.getElementById('addTitleInput').value===""){
            document.getElementById('addTitleInput').style.borderColor="red";
        }if(document.getElementById('addPriceInput').value===null || document.getElementById('addPriceInput').value===""){
            document.getElementById('addPriceInput').style.borderColor="red";
        }if(document.getElementById('addDescInput').value===null || document.getElementById('addDescInput').value===""){
            document.getElementById('addDescInput').style.borderColor="red";
        }if(document.getElementById('addKeywordsInput').value===null || document.getElementById('addKeywordsInput').value===""){
            document.getElementById('addKeywordsInput').style.borderColor="red";
        }if(document.getElementById(`specsTitle0`).value===null || document.getElementById(`specsTitle0`).value==="" || document.getElementById(`specsDesc0`).value===null || document.getElementById(`specsDesc0`).value===""){
            $('#specs-form').append('<p style="color:red">At Least One spec is required</p>')
        }else{
            const response=await axios({ 
            method:"POST",
            url:"/user/sellProduct",
            data:{
                title:document.getElementById('addTitleInput').value,
                price:document.getElementById('addPriceInput').value,
                desc:document.getElementById('addDescInput').value,
                keywords:document.getElementById('addKeywordsInput').value.split(','),
                specs
            }
        });

        if(response.data.status==='success'){
            location.reload();
        }else{
            console.log('Sorry Pack Limit Reached');
        }}
        
       
    }


    // FUNCTIONS FOR EDITING A PRODUCT //////////////////////////////////////////////////
    var productId
    var editButtons=document.getElementsByClassName("btn btn-primary editButton");
    var editButtonsCount=editButtons.length;
    for(var i=0; i<editButtonsCount;i+=1){
        editButtons[i].onclick=async function(e){
            productId=this.id;
            document.getElementById('titleInput').value=document.getElementById(this.id+" title").value;
            document.getElementById('priceInput').value=document.getElementById(this.id+" price").value;
            document.getElementById('descInput').innerText=document.getElementById(this.id+" desc").value;
            document.getElementById('productID').innerText="Product ID: "+" " + this.id;
        }
    }

    const editHandler=async()=>{
      
       try{const response=await axios({
            method:"POST",
            url:"/user/updateProduct",
            data:{
                productId: productId,
                productUpdatedInfo:{
                    price:document.getElementById('priceInput').value,
                    title:document.getElementById('titleInput').value,
                    desc:document.getElementById('descInput').value
                }
                
            }
        })

        console.log('wait...')
        if(response.data.status==='success'){
            location.reload();
        }else{
            console.log('You Are Not authorised to perform this action')
        }}catch(error){
            console.log(error);
        }
        
    }

    // FUNCTIONS FOR DELETING A PRODUCT //////////////////////////////////////////

    var deleteButtons = document.getElementsByClassName("btn btn-danger deleteButton");
    var deleteButtonsCount = deleteButtons.length;
    for (var i = 0; i < deleteButtonsCount; i += 1) {
        deleteButtons[i].onclick = async function(e) {    

        var deleteConfirmation=prompt(`Are you sure you want to delete this product ?                                         Type ${this.id} this below to confirm `);
        console.log(deleteConfirmation)
        if(deleteConfirmation===this.id){
            try{
            const res=await axios({
                method:"POST",
                url:"/user/deleteProduct",
                data:{
                    productId:this.id
                }
            })
            if(res.data.status==='success'){
                console.log('working')
                location.reload();
            }
            if(res.data.status==='unauthorised'){
                console.log("You are not authorised to perform this action");
            }
        }catch(err){
            console.log(err)
         }
        }if(!deleteConfirmation || deleteConfirmation!=this.id){
            console.log("Deletion Cancelled");
        }
        
    };
}
    
</script>


<%- include("../partials/end") %>